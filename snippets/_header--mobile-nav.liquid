<div id="NavDrawer" class="drawer drawer--left">
  <div id="NavDrawer--wrapper">
  <div class="drawer__header">
    <div class="drawer__title"><img src="{{ 'logo.svg' | asset_url }}" alt="{{ shop.name }}"></div>
    <div class="drawer__close js-drawer-close">
      <button type="button" class="icon-fallback-text">
        <span class="icon icon-x" aria-hidden="true"></span>
        <span class="fallback-text">{{ 'layout.drawers.close_menu' | t }}</span>
      </button>
    </div>
  </div>

  <!-- begin mobile-nav -->
    <div id="NavDrawer--list">
  <ul class="mobile-nav" id="NavDrawer--mobile-nav">



    <li class="mobile-nav__item mobile-nav__search">
      {% include 'search-bar' %}
    </li>
    {% for link in linklists.main-menu.links %}
      {% comment %}
        Create a dropdown menu by naming a linklist the same as a link in the parent nav
  
        More info on dropdowns:
          - http://docs.shopify.com/manual/your-website/navigation/create-drop-down-menu
      {% endcomment %}
      {% assign child_list_handle = link.title | handleize %}
      {% if linklists[child_list_handle].links != blank %}
        <li class="mobile-nav__item{% if link.active %} mobile-nav__item--active{% endif %}" aria-haspopup="true">
          <div class="mobile-nav__has-sublist">
            {% if link.title == "Shop" or link.title == 'Our Products' or link.title == 'Get Going Packs' %}
            <a href="#" onclick="return false;" class="mobile-nav__link mobile-nav__toggle-sign-out">{{ link.title }}</a>
            {% else %}
            <a href="{{ link.url }}" class="mobile-nav__link">{{ link.title }}</a>
            {% endif %}
            <div class="mobile-nav__toggle">
              <button type="button" class="icon-fallback-text mobile-nav__toggle-open mobile-nav__toggle-sign-out">
                <span class="dropdown-arrow" aria-hidden="true"></span>
                <span class="fallback-text">See More</span>
              </button>
              <button type="button" class="icon-fallback-text mobile-nav__toggle-close mobile-nav__toggle-sign-out">
                <span class="active-arrow-up" aria-hidden="true"></span>
                <span class="fallback-text">{{ 'cart.general.close_cart' | t | json }}</span>
              </button>
            </div>
          </div>
          <ul class="mobile-nav__sublist">
            {% for childlink in linklists[child_list_handle].links %}
              <li class="mobile-nav__item {% if childlink.active %} mobile-nav__item--active{% endif %}">
                <a href="{{ childlink.url }}" class="mobile-nav__link">{{ childlink.title | escape }}</a>
              </li>
            {% endfor %}
          </ul>
        </li>
      {% else %}
        <li class="mobile-nav__item{% if link.active %} mobile-nav__item--active{% endif %}">
          <a href="{{ link.url }}" class="mobile-nav__link">{{ link.title }}</a>
        </li>
      {% endif %}
    {% endfor %}
      <li class="mobile-nav__item">
      <a href="https://help.decathlon.com/hc/en-us" class="mobile-nav__link">Help</a>
    </li>
    {% comment %}
      If customer accounts are enabled, provide login and create account links
    {% endcomment %}
    {% if shop.customer_accounts_enabled %}
      {% if customer %}
        <li class="mobile-nav__item">
          {% if customer.first_name != blank %}
          <a href="/account">{{ customer.first_name | capitalize }} Account</a>
          {% else %}
            <a href="/account">{{ customer.email | split: '@' | first }} Account</a>
          {% endif %}
        </li>
        <li class="mobile-nav__item">
          {{ 'Sign Out' | customer_logout_link }}
        </li>
      {% else %}
        <li class="mobile-nav__item">
          <a href="/account/login?checkout_url=/">Sign In</a>
        </li>
        <li class="mobile-nav__item">
          <a href="/account/register?checkout_url=/">Create An Account</a>
        </li>
      {% endif %}
    {% endif %}
    </ul>
  </div>
    {% if customer %}
    <div id="NavDrawer--fixed-sign-out">
    <ul class="mobile-nav">
      <li class="mobile-nav__item">
        <a href="/account/logout">Sign Out</a>
      </li>
    </ul>
    </div>
    {%endif%}
  </div>
  <!-- //mobile-nav -->
  <div id="NavDrawer--overlay" class="drawer__close js-drawer-close"></div>
</div>


<script>
  {%comment%}
  Script to toggle which Sign Out menu item is seen in the list.
  {%endcomment%}
  $(document).ready(function() {
    toggleSignOutMenuItem();

    $('.mobile-nav__toggle-sign-out').on('click', 
                                         toggleSignOutMenuItem);
    
    function toggleSignOutMenuItem () {
      var expanded;
      var clickedChildren;
      var expandedMenuItems = 0;
      
      // check if the clicked element is the arrow toggle or the Shop menu
      // check if the sublist is already expanded
      // get the number of li elements in the sublist
      
      if ($(this).hasClass('mobile-nav__toggle-open')){
		expanded = false;
        clickedChildren = $(this).parent().parent().siblings('.mobile-nav__sublist').find('li').length;
      } else if ($(this).hasClass('mobile-nav__toggle-close')){
		expanded = true;
        clickedChildren = $(this).parent().parent().siblings('.mobile-nav__sublist').find('li').length;
      } else if ($(this).parent().hasClass('mobile-nav__has-sublist')) {
        expanded = false;
        clickedChildren = $(this).parent().siblings('.mobile-nav__sublist').find('li').length;
      } else { // being called on pageload
        clickedChildren = 0; 
      }
      
      // Find the height of menu items and the drawer header
      var drawerHeaderHeight = $('.drawer__header').outerHeight();
      var menuItemHeight = $('#NavDrawer--list .mobile-nav__item:last').outerHeight();
      // Find the max height the list can be
      var maxHeight = $('#NavDrawer--wrapper').height() - drawerHeaderHeight - menuItemHeight;
      var menuHeight;
      
      // If drawer is closing, subtract it's menu items
      // If drawer is opening, add it's menu items
      if (expanded) {
        expandedMenuItems -= clickedChildren;
      } else {
        expandedMenuItems += clickedChildren;
      }
        
      var expandedMenuItemsHeight = expandedMenuItems * menuItemHeight;
      menuHeight = $('#NavDrawer--list').height() + expandedMenuItemsHeight;


      if (menuHeight < maxHeight) {
        $('#NavDrawer--mobile-nav li:last').hide();
        // delay showing the Sign Out button soe the sublist closes first
        $('#NavDrawer--fixed-sign-out').delay(400).show(300);
      } else {
        $('#NavDrawer--fixed-sign-out').hide();
        $('#NavDrawer--mobile-nav li:last').show();
      };
    }
  });
  
</script>