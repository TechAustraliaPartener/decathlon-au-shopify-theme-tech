{% assign features = product.metafields.global['features'] %}
{% assign madefor = product.metafields.global.made_for %}
{% assign catchline = product.metafields.global.catchline %}

{%- assign product_images = product.images -%}
{%- assign context_photo_delimiter = '[[contextphoto]]' -%}
{%- assign feature_photo = false -%}

{%- for product_image in product_images -%}
  {% unless product_image.alt contains context_photo_delimiter %}
    {% if feature_photo == false %}
      {% assign feature_photo = product_images[forloop.index0] %}
    {% else %}
      {% assign feature_photo = product_images[forloop.index0] %}
      {% break %}
    {% endif %}
  {% endunless %}
  {% if feature_photo == false and forloop.last %}
    {% assign feature_photo = product_images[0] %}
  {% endif %}
{%- endfor -%}

{% capture feature_photo_srcset %}
  {{ feature_photo | img_url: "20x", format: "pjpg" }} 20w,
  {{ feature_photo | img_url: "380x", format: "pjpg" }} 380w,
  {{ feature_photo | img_url: "440x", format: "pjpg" }} 440w,
  {{ feature_photo | img_url: "500x", format: "pjpg" }} 500w,
  {{ feature_photo | img_url: "580x", format: "pjpg" }} 580w,
  {{ feature_photo | img_url: "620x", format: "pjpg" }} 620w,
  {{ feature_photo | img_url: "700x", format: "pjpg" }} 700w,
  {{ feature_photo | img_url: "820x", format: "pjpg" }} 820w,
  {{ feature_photo | img_url: "900x", format: "pjpg" }} 900w
{% endcapture %}
{% capture feature_photo_sizes %}
  (max-width: 959px) 20px,
  (max-width: 1080px) 380px,
  (max-width: 1280px) 440px,
  (max-width: 1480px) 500px,
  (max-width: 1680px) 580px,
  (max-width: 1880px) 620px,
  (max-width: 2080px) 700px,
  (max-width: 2480px) 820px,
  (max-width: 2680px) 900px
{% endcapture %}

{% comment %}
 @TODO:
 1. Remove the fallback to the stub data (product-proto-features) and the conditional
 2. Replace the photo with something product specific.
{% endcomment %}

{% if features != blank %}
{% comment %}
The easiest way to check for the existence of the new meta fields.
If new metafields are not present, we fallback to the proto feature snippet to
make sure that products without the fields don't break.
{% endcomment %}

  <section class="FeaturesContainer de-Grid de-u-lg-spaceTop3
                  de-u-spaceTop">
    <div class="FeaturesContainer-banner de-u-padBottom de-u-spaceBottom
      de-u-md-padBottom6 de-u-md-spaceBottomNone">
      <div class="de-u-lg-size5of6 de-u-xl-size4of6">
       <h3
          class="de-u-textGrow3 de-u-spaceNone de-u-lineHeight2"
          itemprop="description"
        >
          {{ product.title }} is designed for {{ madefor }}
        </h3>
        <p class="de-u-spaceNone de-u-textSizeBase de-u-textDarkGray">
          {{ catchline }}
        </p>
      </div>
    </div>
    <div class="FeaturesContainer-showcase
                de-u-lg-size1of3 de-u-hidden de-u-lg-block">
      <figure>
        <img
          src="{{ feature_photo | img_url: '500x' }}"
          srcset='{{ feature_photo_srcset }}'
          sizes='{{ feature_photo_sizes }}'
          class="de-u-block"
          alt="">
          <figcaption class="de-u-hiddenVisually">
            A photo of the {{ product.title }} in use
          </figcaption>
      </figure>
    </div>
    <div class="FeaturesContainer-info
              de-u-size1of1 de-u-lg-size2of3 de-u-lg-padLeft6"
       aria-labelledby="Section-features">
    <div class="de-Grid">

  {% for feature in features %}
    {% assign featurearray = feature[1] %}
    {% assign featureicon = featurearray['icon'] %}
    {% unless featurearray == blank %}
        <section
          class="ProductFeature de-u-size1of1 de-u-md-size1of2 de-u-flex
                 de-u-padRight de-u-padBottom"
          aria-labelledby="ProductFeature-{{ forloop.index }}"
          itemprop="additionalProperty"
          itemscope
          itemtype="http://schema.org/PropertyValue">
          <div class="ProductFeature-icon de-u-spaceRight" aria-hidden="true">

            {% if featureicon contains '.jpg'|'.png' %}
            <img
              src="{{ featureicon | replace: 'http://', 'https://'}}"
              alt=""
            >
            {% endif %}
          </div>
          <div class="Feature-spec">
            <header>
              <h3 id="ProductFeature-{{ forloop.index }}" itemprop="name"
                  class="de-u-spaceBottomNone de-u-textGrow2 de-u-lineHeight3">
                {{ featurearray['title'] }}
              </h3>
            </header>
            <p
              itemprop="value"
              class="de-u-textDarkGray de-u-textSizeBase">
              {{ featurearray['text'] }}
            </p>
          </div>
        </section>
    {% endunless %}
  {% endfor %}
    </div>
  </div>
</section>

{% else %}
  {% include 'product-proto-features' %}
{% endif %}
