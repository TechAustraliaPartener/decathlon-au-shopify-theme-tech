{% comment %}
  Variables
{% endcomment %}
{%- assign current_variant = product.selected_or_first_available_variant -%}
{%- assign featured_image = current_variant.image | default: product.featured_image -%}
{%- assign product_images = product.images -%}
{%- assign option_type = 'color' -%}
{%- assign option_type_position = null -%}

{% comment %}
  Store all color option values, and set color option index
{% endcomment %}
{%- capture all_colors -%}
  {%- for product_option in product.options_with_values -%}
    {%- assign product_option_name = product_option.name | downcase -%}
    {%- if product_option_name == option_type -%}
      {%- assign option_type_position = product_option.position -%}
      {%- for value in product_option.values -%}
        {{- value | downcase -}}
        {%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endfor -%}
{%- endcapture -%}

{%- assign all_colors_array = all_colors | split: ',' -%}

{% comment %}
  Store all unique color images of variants
{% endcomment %}
{%- capture all_colors_images -%}
  {%- for color in all_colors_array -%}
    {%- for variant in product.variants -%}
      {%- assign variant_option_type = 'option' | append: option_type_position -%}
      {%- assign variant_option = variant[variant_option_type] | downcase -%}
      {%- if variant_option == color -%}
        {{- variant.image -}}
        {%- unless forloop.last -%},{%- endunless -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}
{%- endcapture -%}

{%- assign all_colors_images_array = all_colors_images | split: ',' -%}

{% comment %}
  Define the start and end of each color's images
{% endcomment %}
{%- capture all_colors_images_indexes -%}
  {%- for color_image in all_colors_images_array -%}
    {%- assign start_index = null -%}
    {%- assign end_index = null -%}
    {%- for product_image in product_images -%}
      {%- if product_image == color_image -%}
        {%- assign start_index = forloop.index0 -%}
      {%- elsif start_index != null and end_index == null -%}
        {%- assign product_image_index = forloop.index0 -%}
        {%- for color_image_inner in all_colors_images_array -%}
          {%- if product_image == color_image_inner and color_image != color_image_inner -%}
            {%- assign end_index = product_image_index -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {%- if forloop.last -%}
        {%- if end_index == null -%}
          {%- assign end_index = forloop.index0 -%}
        {%- endif -%}
        {{- start_index -}},{{- end_index -}}||
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}
{%- endcapture -%}

{%- assign all_colors_images_indexes_array = all_colors_images_indexes | split: '||' -%}

{% comment %}
  Define active variant's color value
{% endcomment %}
{%- capture activeColor -%}
  {%- assign variant_option_type = 'option' | append: option_type_position -%}
  {%- assign variant_option = current_variant[variant_option_type] | downcase -%}
  {{- variant_option -}}
{%- endcapture -%}

{%- for images_indexes in all_colors_images_indexes_array -%}
  {%- assign start_end_index_array = images_indexes | split: ',' -%}
  {%- assign start_index = start_end_index_array[0] | plus: 0 -%}
  {%- assign end_index = start_end_index_array[1] | plus: 0 -%}
  {%- assign color = all_colors_array[forloop.index0] -%}
  {% comment %}
    Product images, grouped by color
  {% endcomment %}
  <section
    data-color="{{- color -}}"
    class="de-CarouselContainer
    {% if color == activeColor %}de-is-active{% endif %}
    js-de-SlickCarouselContainer"
    aria-roledescription="carousel"
    aria-label="Product Image Gallery">
    {% comment %}
      Featured image
    {% endcomment %}
    <div class="de-CarouselFeature
         {% if color == activeColor %}de-is-active{% endif %}
         js-de-SlickCarousel js-de-SlickCarouselFeature"
         id="de-CarouselFeature">
      {%- for product_image in product_images -%}
        {% capture image_srcset %}
          {{ product_image | img_url: "320x" }} 320w,
          {{ product_image | img_url: "480x" }} 480w,
          {{ product_image | img_url: "640x" }} 640w,
          {{ product_image | img_url: "800x" }} 800w,
          {{ product_image | img_url: "960x" }} 960w,
          {{ product_image | img_url: "1120x" }} 1120w,
          {{ product_image | img_url: "1280x" }} 1280w,
          {{ product_image | img_url: "1440x" }} 1440w,
          {{ product_image | img_url: "1800x" }} 1800w
        {% endcapture %}
        {% capture image_sizes %}
          (max-width: 320px) 320px,
          (max-width: 480px) 480px,
          (max-width: 640px) 640px,
          (max-width: 800px) 800px,
          (max-width: 960px) 528px,
          (max-width: 1120px) 640px,
          (max-width: 1280px) 730px,
          (max-width: 1440px) 820px,
          (max-width: 2400px) 1250px
        {% endcapture %}
        {%- if forloop.index0 >= start_index and forloop.index0 < end_index -%}
          <div class="de-CarouselFeature-slide"
            aria-roledescription="slide"
            role="group"
            aria-label="{{ forloop.index | minus: start_index }} of {{ end_index | minus: start_index }}">
            <button class="de-CarouselFeature-btn">
              <img
                class="de-CarouselFeature-image js-de-SlickCarouselSlide"
                {% if color == activeColor and forloop.index0 == start_index %}
                  srcset="{{ image_srcset }}"
                  sizes="{{ image_sizes }}"
                {% endif %}
                data-srcset="{{ image_srcset }}"
                data-sizes="{{ image_sizes }}"
                >
            </button>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
    {% comment %}
      Thumbnail images
    {% endcomment %}
    <div
      class="de-CarouselThumbnail
              {% if color == activeColor %}de-is-active{% endif %}
              js-de-SlickCarousel js-de-SlickCarouselThumbnail"
      data-carousel-color="{{- all_colors_array[forloop.index0] -}}">
      {%- for product_image in product_images -%}
        {% capture image_srcset %}
          {{ product_image | img_url: "80x" }} 80w,
          {{ product_image | img_url: "100x" }} 100w,
          {{ product_image | img_url: "120x" }} 120w,
          {{ product_image | img_url: "140x" }} 140w,
          {{ product_image | img_url: "160x" }} 160w,
          {{ product_image | img_url: "180x" }} 180w,
          {{ product_image | img_url: "200x" }} 200w,
          {{ product_image | img_url: "220x" }} 220w,
          {{ product_image | img_url: "240x" }} 240w
        {% endcapture %}
        {% capture image_sizes %}
          (max-width: 1000px) 80px,
          (max-width: 1140px) 100px,
          (max-width: 1300px) 120px,
          (max-width: 1500px) 140px,
          (max-width: 1650px) 160px,
          (max-width: 1850px) 180px,
          (max-width: 2000px) 200px,
          (max-width: 2200px) 220px,
          (max-width: 2400px) 240px
        {% endcapture %}
        {%- if forloop.index0 >= start_index and forloop.index0 < end_index -%}
          <div class="de-SlickSlide de-u-spaceBottom03
            de-CarouselThumbnail-slide"
            aria-controls="de-CarouselFeature"
            aria-roledescription="slide"
            role="group"
            aria-label="{{ forloop.index | minus: start_index }} of {{ end_index | minus: start_index }}">
            <button class="de-CarouselThumbnail-btn">
              <img class="de-CarouselThumbnail-image js-de-SlickCarouselSlide"
                data-srcset="{{ image_srcset }}"
                data-sizes="{{ image_sizes }}">
            </button>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </section>
{%- endfor -%}
