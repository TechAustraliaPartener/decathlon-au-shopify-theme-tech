{% include 'js-gtm-datalayer-product-stock' %}
{% include 'shogun-products', content: product %}
{{product.metafields.shogun.above}}
{% comment %}
  * Depending on the existence of a product's new metafields
  * (e.g. `metafields.features`), conditionally serve the new or older design.
{% endcomment %}
{% if product.metafields.global.features != blank %}
  {% comment %} Serve new product page {% endcomment %}
  {% include 'compositions-product-page' %}
{% else %}
  {% comment %} Serve old product page {% endcomment %}
  {% include 'compositions-product-page-legacy' %}
{% endif %}


{{product.metafields.shogun.below}}

{%- assign price_valid_until = 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' -%}
<script type="application/ld+json">
{
  "@context": "http://schema.org/",
  "@type": "Product",
  "name": "{{ product.title | strip_html | escape }}",
  "url": "{{ shop.url }}{{ product.url }}",
  {%- if product.first_available_variant.sku != blank -%}
    "sku": "{{ product.first_available_variant.sku }}",
  {%- else -%}
    "sku": "{{ product.first_available_variant.id }}",
  {%- endif -%}
  {%- if product.first_available_variant.barcode.size == 12 -%}
    "gtin12": {{ product.first_available_variant.barcode }},
  {%- elsif product.first_available_variant.barcode.size == 13 -%}
    "gtin13": {{ product.first_available_variant.barcode }},
  {%- elsif product.first_available_variant.barcode.size == 14 -%}
    "gtin14": {{ product.first_available_variant.barcode }},
  {%- elsif product.first_available_variant.barcode != nil -%}
    "mpn": "{{ product.first_available_variant.barcode }}",
  {%- endif -%}
  "brand": {
    "@type": "Thing",
    "name": "{{ product.vendor | escape }}"
  },
  "description": {{ product.description | strip_html | json | replace: '\n', ' ' | strip }},
  "image": "https:{{ product.featured_image.src | img_url: 'grande' }}",
  {%- if product.first_available_variant.weight != blank -%}
  "weight": {
    "@type": "QuantitativeValue",
    {%- if product.first_available_variant.weight_unit != blank -%}
    "unitCode": "{{ product.first_available_variant.weight_unit }}",
    {%- endif -%}
    "value": "{{ product.first_available_variant.weight | weight_with_unit: product.first_available_variant.weight_unit }}"
  },
  {%- endif -%}
  {%- if product.variants -%}
    "offers": [
      {%- for variant in product.variants -%}
        {
          "@type" : "Offer",
          "priceCurrency": "{{ shop.currency }}",
          "price": "{{ variant.price | money_without_currency | strip_html }}",
          "itemCondition" : "http://schema.org/NewCondition",
          "availability" : "http://schema.org/{%- if product.available -%}InStock{%- else -%}OutOfStock{%- endif -%}",
          "priceValidUntil": "{{ price_valid_until }}",
          "description": {{ product.description | strip_html | json | replace: '\n', ' ' | strip }},
          {%- if variant.image -%}
          {% assign variant_image_size = variant.image.width | append: 'x' %}
          "image": "http:{{ variant.image.src | img_url: variant_image_size }}",
          {%- else -%}
          "image": "https:{{ product.featured_image.src | img_url: 'grande' }}",
          {%- endif -%}
          {%- if variant.title != blank -%}
          "name" : "{{ product.title }} - size {{ variant.title | escape }}",
          {%- endif -%}
          {%- if variant.barcode.size == 12 -%}
          "gtin12": {{ variant.barcode }},
          {%- elsif variant.barcode.size == 13 -%}
          "gtin13": {{ variant.barcode }},
          {%- elsif variant.barcode.size == 14 -%}
          "gtin14": {{ variant.barcode }},
          {%- elsif variant.barcode != nil -%}
          "mpn": "{{ variant.barcode }}",
          {%- endif -%}
          {%- if variant.sku != blank -%}
          "sku": "{{ variant.sku }}",
          {%- else -%}
          "sku": "{{ variant.id }}",
          {%- endif -%}
          "url": "{{ shop.url }}{{ variant.url }}"
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
    {%- if product.metafields.okendo.ReviewCount > 0 -%}
    ,"aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "{{ product.metafields.okendo.ReviewAverageValue }}",
      "ratingCount": "{{ product.metafields.okendo.ReviewCount }}"
    }
    {%- endif -%}
  {%- endif -%}
}
</script>


