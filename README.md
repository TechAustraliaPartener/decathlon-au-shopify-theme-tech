# SETUP README

## Project Setup

1. In Mac Terminal navigate to your project's root folder.
2. Make sure themekit is installed. If it's not go to https://shopify.github.io/themekit/
3. There should be a config.yml.sample in the root of the project. Duplicate this file and name it config.yml. This will have the default api information for Shopify. If you're working on a cloned theme because multiple developers are on the project, this is where you'd update your theme id. Make sure config.yml is not being tracked in the repo.
4. Type the command **npm install** and press enter. This will install all node dependencies for the project.
5. Type **gulp** and press enter. This will run all project gulp tasks and also ensure that all dependencies are installed properly. If a dependency does not exist you'll see an error in terminal. If you see this error, install the missing dependency by typing the command **npm install _package_name_ --save-dev**. After this make sure to commit your package.json file so that the next user has the dependencies they need.

## Gulp Config

There is a file in the root directory called **gulp-config**. This file maintains the list of directories, stylesheets, sprites, and javascript files. All configuration for gulp should be here.

## Watch

Typing **npm run dev** will watch a variety of directories for changes and then perform the needed gulp task. In addition to running gulp watch it will also run Themekit. You must have Shopify Themekit installed locally and the project connected in order for this to work.

- If svgs are dropped into src/svg/icons sass and svg sprite will run.
- If changes are made to any files in the src/scss** folder then the **gulp sass\*\* task will run which generates the css file, combines the media queries, and then converts it into a style.css.liquid file.
- If changes are made to any file inside the src/js/** folder, **gulp uglify\*\* will run which lints all js files in that directory, concats and files that need it, and then minify all files.

## Stylesheets

In gulp-config is an array of stylesheets. Each item in the array should correlate with a .scss file in **src/scss**. So for example if there's a node in the stylesheets array called "index", you'll need a file at **src/scss/index.scss** in order for that to generate a css file.

If you need sub scss modules to be included in your stylesheet, simply create a folder that matches the name in the array and the watch task will watch those directories for changes. For instance if you had a \_hero.scss snippet that you wanted to only call in the index.scss file, you could place the file in **src/scss/index/** and include the path in your **index.scss** sheet. After that if **npm run dev** is active any changes to index.scss and any of the files in the index folder will trigger a compilation.

## Javascript

In the gulp-config file there is a large js object. This object maintains a list of files to concat and then minify. The structure for this is a top level key denotes the name of the file that will be generated by the concat and minify tasks. The value for this top level key is another object which lists all the files that need to be concatenated into a single javascript file. Each node within this sub object must include the name of the file without the **.js** extension, and the directory where the file resides.

While running **npm run dev** eacch file listed in this object will be watched for changes and only concatenate the block that's been changed, and run then through jslint. Note that files inside the **src/js/plugins** folder will not go through the jslint task.

## SVG Icons

There's a task in gulp to create an SVG icon sprite, and to update the src/scss/globals/\__spritename_ .scss file with the appropriate classes to call the icon. If you would like to add new icons do the following:

- To create new sprites add the name of your sprite to the gulp-config array under "sprites".
- Upload your svg icon to **/src/svg/_spritename_/** With spritename matching the name you placed in the array in gulp-config.
- Run the command **gulp sprites** in your root directory.
- To add your icon to a html document use the classes ** icon icon--_filename_ **
- If you'd like to change the css that is output into **\_icons.scss** you do so by going to **src/scss/globals/mixins/\_svg-template.scss**. The file is built using mustache templating.
- If you'd like to add additional sprites you can add them to createSprites object towards the top of the gulp file. The names you enter must match with the folder you create inside the SVG directory.
- While **npm run dev** is going dropping new svgs into the folder will update the sprite.

## Updating Patterns Submodule

Do this any time updates were committed in the decathlon-patterns repo and merged into that repo's master branch.

Here are the steps followed to create this PR:

1. Enter the directory for the shopify repo: `cd shopify-theme-decathlonusa`
1. Checkout the `cloudfour-dev` branch: `git checkout cloudfour-dev`
1. Make sure the branch is up-to-date: `git pull`
1. Checkout a new branch from there: `git checkout -b chore/update-patterns`
1. Update the patterns: `npx gulp updatePatterns`
1. Double-check that updated files appear correct (all begin with `patterns`): `git status`
1. Add modified and new files: `git add -A`
1. Commit the changes: `git commit -m "Update patterns to latest"`
1. Push to the remote: `git push -u origin chore/update-patterns`

## Persistent Cart (PC)

The Persistent Cart feature is a combination of client-side code and a server-side application with a database, that together do the following:

1. Create an association between a customer and a cart
1. Keep a customer tracking a specific cart by using a single cart token (ID) for as long as possible
1. Reconcile cart contents for a customer, combining cart contents from before they login with their persisted cart during logged-in session.
1. Rehydrate carts from the database if Shopify expires a cart a customer has been using
1. Listen to Shopify webhooks to keep up-to-date with cart contents as well as checkout events and customer deletions

### Building the Persistent Cart for Production

1. Run `npm run build:heroku:production`
1. This sets 2 values in code, the `DECATHLON_PERSISTENT_CART_URL` and the `STOREFRONT_API_KEY`, used to create a custom checkout that works across devices with PC
1. If either of these values needs to change, for whatever reason, reference the script in the project's `package.json` and replace values to be used in the build

### Setting Persistent Cart API URL

You have the ability to override the Persistent Cart API URL used by the client-side code via the `DECATHLON_PERSISTENT_CART_URL` environment variable.

Example:

```
DECATHLON_PERSISTENT_CART_URL=https://<some-url> npm run build
```

This will build the Persistent Cart JS file pointing to the provided API URL.

#### Production Default Domains & API URLs

Production Domains Default: `['www.decathlon.com']`

This can be overridden via a `PRODUCTION_DOMAINS` environment variable consisting of a comma-delimited list. Example:

```
PRODUCTION_DOMAINS='foo.com,bar.com' npm run build
```

Production API URL Default: `'https://persistent-cart-decathlonusa.herokuapp.com'`

This can be overridden via a `PRODUCTION_API_URL` environment. Example:

```
PRODUCTION_API_URL='foo.com' npm run build
```

#### Staging Default Domains & API URLs

Staging Domains Default: `['testing-decathlon-usa.myshopify.com']`

This can be overridden via a `STAGING_DOMAINS` environment variable consisting of a comma-delimited list. Example:

```
STAGING_DOMAINS='foo.com,bar.com' npm run build
```

Staging API URL Default: `'https://persistent-cart-decathlonusa-s.herokuapp.com'`

This can be overridden via a `STAGING_API_URL` environment. Example:

```
STAGING_API_URL='foo.com' npm run build
```

#### How are these all used?

There is a check for `window.location.hostname` to determine if the result is a "production" or "staging" domain. Based on that, the "production" or "staging" API URL will be used.

All of this logic can be overridden by using the `DECATHLON_PERSISTENT_CART_URL` environment variable as shown above.

## Cypress tests

Cypress tests have been added to help test the Persistent Cart E2E flow.

### Requirements

You will need a Decathlon user account to be able to add items to cart and store them in the Persistent Cart. You can create a user via the Shopify theme you are testing against.

### Setup

Create a copy of the `.env.sample` file making sure to rename it to `.env`. Update the environment variables removing the sample values.

| Environment Variable        | Description                                                                                                                                                                                                                                                                       |
| --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `DEC_SHARED_PREVIEW_URL`    | The [Cypress base URL](https://docs.cypress.io/guides/references/best-practices.html#Setting-a-global-baseUrl) used by all tests. This should be a [Shopify Shared Preview URL](https://help.shopify.com/en/manual/using-themes/adding-themes#share-a-theme-preview-with-others). |
| `DEC_USERNAME`              | The username for the Decathlon test account.                                                                                                                                                                                                                                      |
| `DEC_PASSWORD`              | The password for the Decathlon test account.                                                                                                                                                                                                                                      |
| `DEC_ONE_SIZE_PRODUCT_PATH` | Some Persistent Cart tests need a product to test against. This sets the path to that product. The product must not require a size selection ("one-size" products only). See `.env.sample` file for example.                                                                      |

### Cypress test dashboard

```
npm run cypress:open
```
